import _regeneratorRuntime from"@babel/runtime/regenerator";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import*as _ from"lodash";import*as FileSystem from"expo-file-system";import MD5 from"crypto-js/md5";var _baseDir=FileSystem.cacheDirectory+"expo-image-cache/";var getBaseDir=function getBaseDir(){return _baseDir;};export var setBaseDir=function setBaseDir(baseDir){return _baseDir=baseDir;};export var CacheEntry=function(){function CacheEntry(uri,options){_classCallCheck(this,CacheEntry);this.uri=uri;this.options=options;}_createClass(CacheEntry,[{key:"createBaseDir",value:function createBaseDir(){var BASE_DIR,_ref,exists;return _regeneratorRuntime.async(function createBaseDir$(_context){while(1){switch(_context.prev=_context.next){case 0:BASE_DIR=getBaseDir();_context.next=3;return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(BASE_DIR));case 3:_ref=_context.sent;exists=_ref.exists;if(exists){_context.next=13;break;}_context.prev=6;_context.next=9;return _regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR,{intermediates:true}));case 9:_context.next=13;break;case 11:_context.prev=11;_context.t0=_context["catch"](6);case 13:case"end":return _context.stop();}}},null,null,[[6,11]]);}},{key:"getPath",value:function getPath(){var uri,options,_ref2,path,exists,tmpPath,result;return _regeneratorRuntime.async(function getPath$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:uri=this.uri,options=this.options;_context2.next=3;return _regeneratorRuntime.awrap(getCacheEntry(uri));case 3:_ref2=_context2.sent;path=_ref2.path;exists=_ref2.exists;tmpPath=_ref2.tmpPath;if(!exists){_context2.next=9;break;}return _context2.abrupt("return",path);case 9:_context2.next=11;return _regeneratorRuntime.awrap(FileSystem.createDownloadResumable(uri,tmpPath,options).downloadAsync());case 11:result=_context2.sent;if(!(result&&result.status!==200)){_context2.next=14;break;}return _context2.abrupt("return",undefined);case 14:this.createBaseDir();_context2.next=17;return _regeneratorRuntime.awrap(FileSystem.moveAsync({from:tmpPath,to:path}));case 17:return _context2.abrupt("return",path);case 18:case"end":return _context2.stop();}}},null,this);}}]);return CacheEntry;}();var CacheManager=function(){function CacheManager(){_classCallCheck(this,CacheManager);}_createClass(CacheManager,null,[{key:"get",value:function get(uri,options){if(!CacheManager.entries[uri]){CacheManager.entries[uri]=new CacheEntry(uri,options);}return CacheManager.entries[uri];}},{key:"clearCache",value:function clearCache(){var BASE_DIR;return _regeneratorRuntime.async(function clearCache$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:BASE_DIR=getBaseDir();_context3.next=3;return _regeneratorRuntime.awrap(FileSystem.deleteAsync(BASE_DIR,{idempotent:true}));case 3:_context3.next=5;return _regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 5:case"end":return _context3.stop();}}});}},{key:"getCacheSize",value:function getCacheSize(){var result;return _regeneratorRuntime.async(function getCacheSize$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(_baseDir));case 2:result=_context4.sent;if(result.exists){_context4.next=5;break;}throw new Error(_baseDir+" not found");case 5:return _context4.abrupt("return",result.size);case 6:case"end":return _context4.stop();}}});}}]);return CacheManager;}();CacheManager.entries={};export{CacheManager as default};var getCacheKey=function getCacheKey(uri){var filename=uri.substring(uri.lastIndexOf("/"),uri.indexOf("?")===-1?uri.length:uri.indexOf("?"));var ext=filename.indexOf(".")===-1?".jpg":filename.substring(filename.lastIndexOf("."));return{key:'I'+MD5(uri),ext:ext};};export var removeCacheEntry=function removeCacheEntry(uri){var _getCacheKey,ext,key;return _regeneratorRuntime.async(function removeCacheEntry$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_getCacheKey=getCacheKey(uri),ext=_getCacheKey.ext,key=_getCacheKey.key;_context5.next=3;return _regeneratorRuntime.awrap(FileSystem.deleteAsync(""+getBaseDir()+key+ext,{idempotent:true}));case 3:return _context5.abrupt("return",_context5.sent);case 4:case"end":return _context5.stop();}}});};var getCacheEntry=function getCacheEntry(uri){var BASE_DIR,_getCacheKey2,ext,key,path,tmpPath,info,_info,_exists;return _regeneratorRuntime.async(function getCacheEntry$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:BASE_DIR=getBaseDir();_getCacheKey2=getCacheKey(uri),ext=_getCacheKey2.ext,key=_getCacheKey2.key;path=""+BASE_DIR+key+ext;tmpPath=""+BASE_DIR+key+"-"+_.uniqueId()+ext;_context6.prev=4;_context6.next=7;return _regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 7:_context6.next=11;break;case 9:_context6.prev=9;_context6.t0=_context6["catch"](4);case 11:info=null;_context6.prev=12;_context6.next=15;return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(path));case 15:info=_context6.sent;_info=info,_exists=_info.exists;return _context6.abrupt("return",{exists:_exists,path:path,tmpPath:tmpPath});case 20:_context6.prev=20;_context6.t1=_context6["catch"](12);case 22:return _context6.abrupt("return",{exists:false,path:path,tmpPath:tmpPath});case 23:case"end":return _context6.stop();}}},null,null,[[4,9],[12,20]]);};
//# sourceMappingURL=CacheManager.js.map